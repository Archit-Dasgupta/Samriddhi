<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Samriddhi</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <!-- NAV -->
  <header class="topbar">
    <div class="topbar-inner">
      <button class="hamb" id="hamb" aria-label="Menu" aria-expanded="false">‚ò∞</button>
      <div class="brand-left" onclick="location.hash='#/home'">
        <div class="logo-square">
          <img src="img/logo.svg" alt="Samriddhi logo">
        </div>
        <div class="brand-text"><span class="brand-strong">Samriddhi</span></div>
      </div>
      <nav class="nav-right" id="navRight">
        <a class="nav-link" data-route="home" href="#/home">Home</a>
        <a class="nav-link" data-route="modules" href="#/modules">Programs</a>
        <a class="nav-link" data-route="banking" href="#/banking">Banking <span class="chip-new">NEW</span></a>
        <a class="nav-link" data-route="toolkits" href="#/toolkits">Toolkit</a>
        <button id="btnOpenLogin" class="btn login-pill">Login/Register</button>
        <a id="navProfile" class="nav-link hidden" data-route="profile" href="#/profile">Profile</a>
      </nav>
    </div>
  </header>

  <!-- HOME -->
  <main class="container" id="page-home" role="main">
    <section class="hero card">
      <div class="hero-text">
        <h1>Grow your tailoring business with confidence</h1>
        <p class="muted">
          Practical video lessons, simple calculators and access to partner banking products‚Äîdesigned for women entrepreneurs in small towns and villages.
        </p>
        <div class="row gap" style="display:flex;gap:8px;align-items:center">
          <button class="btn primary" id="btnStart">Login / Register</button>
          <a class="btn ghost" href="#/modules">Browse Programs</a>
        </div>
      </div>
      <img class="hero-art" src="img/img2.png" alt="Woman tailor learning with Samriddhi">
    </section>

    <!-- Value Proposition / Why / Testimonials -->
    <section class="info">
      <article class="card">
        <h3>Value Proposition</h3>
        <ul class="bullets">
          <li>Phone-first learning in your language</li>
          <li>Fair pricing & cashbook tools for tailors</li>
          <li>Safe access to partner banking products</li>
        </ul>
      </article>
      <article class="card">
        <h3>Why Samriddhi</h3>
        <ul class="bullets">
          <li>Built for small towns & home businesses</li>
          <li>Short, practical videos (5‚Äì10 minutes)</li>
          <li>Trusted guidance on loans, FDs, RDs</li>
        </ul>
      </article>
      <article class="card">
        <h3>Get started in minutes</h3>
        <p class="muted">No email needed. Use your phone number and start learning today.</p>
        <div><a class="btn primary" href="#/login">Login with phone</a></div>
      </article>
    </section>

    <section class="testimonials">
      <div class="card"><strong>Asha, Murbad</strong><p class="muted">‚ÄúI learned to price blouses properly and doubled my monthly income.‚Äù</p></div>
      <div class="card"><strong>Rekha, Jalgaon</strong><p class="muted">‚ÄúThe FD calculator helped me plan my savings without guesswork.‚Äù</p></div>
      <div class="card"><strong>Farida, Osmanabad</strong><p class="muted">‚ÄúVideos are short and clear‚ÄîI learn between customer orders.‚Äù</p></div>
    </section>
  </main>

  <!-- LOGIN: STEP 1 (phone) -->
  <main class="container hidden" id="page-login">
    <section class="login card">
      <h2>Login or Register</h2>
      <p class="muted">Enter your mobile number to continue</p>
      <div class="phone-input">
        <div class="phone-cc">+91</div>
        <input id="phoneNumber" inputmode="numeric" pattern="[0-9]*" maxlength="10" placeholder="0000000000" aria-label="Phone number"/>
      </div>
      <button id="btnProceedPhone" class="btn primary wide">Continue</button>
      <p class="tiny muted">Demo: any 10-digit number works.</p>
      <div id="login_msg" class="tiny muted" role="alert"></div>
    </section>
  </main>

  <!-- LOGIN: STEP 2 EXISTING (password) -->
  <main class="container hidden" id="page-password">
    <section class="card">
      <h2>Enter password</h2>
      <p class="muted">We found your account. Enter password to continue.</p>
      <input id="login_pass" type="password" placeholder="Password" aria-label="Password"/>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <button id="btnLogin" class="btn primary">Login</button>
        <a href="#/login" class="btn ghost">Back</a>
        <span id="pass_msg" class="tiny muted" role="alert"></span>
      </div>
    </section>
  </main>

  <!-- ACCOUNT CREATION (info + password) -->
  <main class="container hidden" id="page-create">
    <section class="card">
      <h2>Create your account</h2>
      <p class="muted">Finish setting up your profile and choose a password.</p>
      <div class="grid2" style="gap:8px">
        <label>Phone (read-only)<input id="create_phone" disabled/></label>
        <label>Name<input id="create_name" placeholder="Your name"/></label>
        <label>Village / City<input id="create_city" placeholder="Your town"/></label>
        <label>Language
          <select id="create_lang"><option>English</option><option>Hindi</option><option>Marathi</option></select>
        </label>
        <label>Occupation<input id="create_job" placeholder="e.g., Tailor"/></label>
        <label>Password<input id="create_pw" type="password" placeholder="At least 4 characters"/></label>
        <label>Confirm password<input id="create_cpw" type="password"/></label>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <button id="btnCreate" class="btn primary">Create account</button>
        <a href="#/login" class="btn ghost">Back</a>
        <span id="create_msg" class="muted tiny" role="alert"></span>
      </div>
    </section>
  </main>

  <!-- DASHBOARD -->
  <main class="container hidden" id="page-dashboard">
    <section class="card">
      <h2>Welcome to your dashboard</h2>
      <p class="muted" id="dash_sub">Let‚Äôs build steady income with the right skills and safer finance.</p>

      <div class="progress" aria-label="Course progress" title="Course progress">
        <span id="progBar" style="width:0%"></span>
      </div>
      <p class="tiny muted">Progress: <span id="progPct">0%</span> ‚Ä¢ Literacy: <span id="litLevel">‚Äî</span> (<span id="litScore">0</span>/10)</p>

      <div class="quick-actions" style="display:flex;flex-wrap:wrap;gap:12px;margin-top:8px">
        <button id="btnTakeTest" class="btn ghost">Take Financial Literacy Test</button>
        <button id="btnResume" class="btn primary">Resume Course</button>
        <a class="btn ghost" href="#/modules" id="btnExplorePrograms">Explore Programs</a>
        <a class="btn ghost" href="#/banking">Banking</a>
        <a class="btn ghost" href="#/toolkits">Toolkits</a>
      </div>
      <p id="lockMsg" class="muted tiny" style="margin-top:8px"></p>
    </section>
  </main>

  <!-- FINANCIAL LITERACY TEST -->
  <main class="container hidden" id="page-lit">
    <section class="card">
      <h2>Financial Literacy Test</h2>
      <p class="muted">10 quick questions on savings, interest and borrowing. For demo only.</p>
      <div id="litForm"></div>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <button id="litSubmit" class="btn primary">Submit</button>
        <button id="litReset" class="btn ghost">Reset</button>
        <span id="litMsg" class="muted"></span>
      </div>
    </section>
  </main>

  <!-- PROGRAMS / MODULES -->
  <main class="container hidden" id="page-modules">
    <section class="modules-grid">
      <aside class="left-rail card">
        <div class="rail-header">
          <span class="crumb">Home</span> / <span class="crumb strong">Programs</span>
        </div>
        <ol class="steps">
          <li class="done">Pick a track</li>
          <li class="done">Set your goals</li>
          <li class="active">Review content</li>
        </ol>
        <button class="btn ghost small" id="btnExitGuide">Go to Dashboard</button>
      </aside>
      <section class="recos card">
        <div class="recos-head">
          <h2>Recommended course content</h2>
          <div class="save-indicator">Saved ‚Ä¢ Total length: <span id="totalLen">0m</span></div>
        </div>
        <div id="moduleList" class="module-sections"></div>
      </section>
    </section>
  </main>

  <!-- BANKING -->
  <main class="container hidden" id="page-banking">
    <section class="bank-wrap">
      <div class="bank-hero card">
        <img class="bank-img" alt="Bank" src="img/img.png"/>
        <aside class="calc card">
          <h3 class="calc-title">Fixed Deposit (FD) Calculator</h3>
          <div class="grid2">
            <label>Amount (‚Çπ)<input id="invAmount" type="number" value="100000"/></label>
            <label>Sr. Citizen
              <select id="srCitizen"><option>No</option><option>Yes</option></select>
            </label>
          </div>
          <label>Interest rate and tenure
            <select id="tenurePick">
              <option value="60|8.2">5Y (8.2%)</option>
              <option value="36|7.6">3Y (7.6%)</option>
              <option value="12|7.0">1Y (7.0%)</option>
            </select>
          </label>
          <div class="facts">
            <div class="fact"><span>Investment amount</span><strong id="fInv">‚Çπ1,00,000</strong></div>
            <div class="fact"><span>Compounding</span><strong>Quarterly</strong></div>
            <div class="fact"><span>FD rate applicable</span><strong id="fRate">8.2%</strong></div>
            <div class="fact"><span>FD tenure</span><strong id="fTenure">5Y</strong></div>
            <div class="fact"><span>Maturity amount</span><strong id="fMaturity">‚Çπ‚Äî</strong></div>
          </div>

          <h3 style="margin-top:16px">Recurring Deposit (RD) Calculator</h3>
          <div class="grid2">
            <label>Monthly deposit (‚Çπ)<input id="rd_amt" type="number" value="2000"/></label>
            <label>Tenure (months)<input id="rd_months" type="number" value="24"/></label>
          </div>
          <div class="fact"><span>Estimated maturity</span><strong id="rd_out">‚Çπ‚Äî</strong></div>

          <h3 style="margin-top:16px">Loan EMI Calculator</h3>
          <div class="grid2">
            <label>Loan amount (‚Çπ)<input id="loan_amt" type="number" value="25000"/></label>
            <label>Tenure (months)<input id="loan_tenure" type="number" value="12"/></label>
          </div>
          <div class="grid2">
            <label>Rate p.a. (%)<input id="loan_rate" type="number" value="20"/></label>
            <label>Monthly income (‚Çπ)<input id="loan_income" type="number" value="15000"/></label>
          </div>
          <label>Existing EMIs (‚Çπ)<input id="loan_emi" type="number" value="0"/></label>
          <div class="fact"><span>Estimated EMI</span><strong id="emi_out">‚Çπ‚Äî</strong></div>
          <div class="tiny muted">For demo only, not financial advice.</div>
          <div class="grid2" style="margin-top:8px">
            <a class="btn ghost" href="#/open-account">Open an account</a>
            <a class="btn primary" href="#/loan">Apply for a loan</a>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <!-- OPEN ACCOUNT (demo) -->
  <main class="container hidden" id="page-open-account">
    <section class="card">
      <h2>Open an Account (Demo)</h2>
      <div class="grid2" style="gap:8px">
        <label>Full name<input id="acc_name" placeholder="e.g., Sita Devi"/></label>
        <label>Village / City<input id="acc_city" placeholder="e.g., Murbad"/></label>
        <label>PAN (optional)<input id="acc_pan" placeholder="ABCDE1234F"/></label>
        <label>Initial deposit (‚Çπ)<input id="acc_amt" type="number" value="5000"/></label>
        <label>Account type
          <select id="acc_type"><option>Basic Savings</option><option>Regular Savings</option></select>
        </label>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px">
        <button id="acc_submit" class="btn primary">Submit</button>
        <a class="btn ghost" href="#/banking">Back to Banking</a>
        <span id="acc_msg" class="muted"></span>
      </div>
    </section>
  </main>

  <!-- LOAN (demo) -->
  <main class="container hidden" id="page-loan">
    <section class="card">
      <h2>Apply for a Micro-Loan (Demo)</h2>
      <p class="tiny muted">For demo only.</p>
      <div style="margin-top:12px; display:flex; gap:8px">
        <button id="loan_submit" class="btn primary">Check Eligibility</button>
        <a class="btn ghost" href="#/banking">Back to Banking</a>
        <span id="loan_msg" class="muted"></span>
      </div>
    </section>
  </main>

  <!-- TOOLKITS -->
  <main class="container hidden" id="page-toolkits">
    <section class="card">
      <h2>Toolkits</h2>
      <p class="muted">Download simple templates to track your business.</p>
      <div class="tool-grid">
        <div class="card">
          <h3>Cashbook (XLSX)</h3>
          <p class="tiny muted">Daily income & expense tracker.</p>
          <button class="btn primary" data-dl="cashbook.xlsx">Download</button>
        </div>
        <div class="card">
          <h3>Pricing Calculator (XLSX)</h3>
          <p class="tiny muted">Estimate blouse/alteration prices.</p>
          <button class="btn primary" data-dl="pricing.xlsx">Download</button>
        </div>
        <div class="card">
          <h3>Daily Tracker (CSV)</h3>
          <p class="tiny muted">Track orders and status.</p>
          <button class="btn primary" data-dl="tracker.csv">Download</button>
        </div>
      </div>
    </section>
  </main>

  <!-- PROFILE -->
  <main class="container hidden" id="page-profile">
    <section class="card">
      <h2>Your Profile</h2>
      <p class="muted">Manage your details. Stored in your browser for demo purposes.</p>
      <div class="grid2" style="gap:8px">
        <label>Phone (read-only)<input id="prof_phone" disabled/></label>
        <label>Name<input id="prof_name" placeholder="Your name"/></label>
        <label>Village / City<input id="prof_city" placeholder="Your town"/></label>
        <label>Occupation<input id="prof_job" placeholder="e.g., Tailor"/></label>
        <label>Language
          <select id="prof_lang"><option>English</option><option>Hindi</option><option>Marathi</option></select>
        </label>
        <label>Change password<input id="prof_pw" type="password" placeholder="New password"/></label>
      </div>
      <div class="tiny muted">Literacy: <span id="prof_lit">‚Äî</span> ‚Ä¢ Course progress: <span id="prof_prog">0%</span></div>
      <div style="margin-top:12px; display:flex; gap:8px; align-items:center">
        <button id="prof_save" class="btn primary">Save</button>
        <button id="prof_logout" class="btn ghost">Log out</button>
        <span id="prof_msg" class="muted"></span>
      </div>
    </section>
  </main>

  <footer class="tiny muted center">¬© Samriddhi</footer>

  <script>
    // ====== Helpers & Storage ======
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>document.querySelectorAll(s);

    const PAGES = ['home','login','password','create','dashboard','lit','modules','banking','open-account','loan','toolkits','profile'];
    function show(page){
      PAGES.forEach(p=>$('#page-'+p)?.classList.add('hidden'));
      $('#page-'+page)?.classList.remove('hidden');
      const newHash = '#/'+page;
      if(location.hash !== newHash) window.location.hash = newHash;
      setActiveNav(page);
    }
    window.addEventListener('hashchange', ()=>{
      const raw = location.hash.replace('#/','') || 'home';
      show(PAGES.includes(raw) ? raw : 'home');
    });

    // nav active + hamburger
    const hamb = $('#hamb'); const navRight = $('#navRight');
    hamb.onclick = ()=>{
      const open = navRight.classList.toggle('open');
      hamb.setAttribute('aria-expanded', String(open));
    };
    function setActiveNav(route){
      $$('#navRight .nav-link').forEach(a=>{
        a.classList.toggle('active', a.dataset.route===route);
      });
      if(window.innerWidth<=600){ navRight.classList.remove('open'); hamb.setAttribute('aria-expanded','false'); }
    }

    const ACC_KEY = 'sam_accounts';
    const SESS_KEY = 'sam_session';
    const LIT_SCORE = 'sam_fin_score';
    const LIT_LEVEL = 'sam_fin_level';
    const COURSE_STATE = 'sam_course_state';
    const COURSE_PROGRESS = 'sam_course_progress';

    function getAccounts(){ return JSON.parse(localStorage.getItem(ACC_KEY) || '{}'); }
    function setAccounts(obj){ localStorage.setItem(ACC_KEY, JSON.stringify(obj)); }
    function setSession(obj){ localStorage.setItem(SESS_KEY, JSON.stringify(obj)); }
    function getSession(){ return JSON.parse(localStorage.getItem(SESS_KEY) || 'null'); }
    function clearSession(){ localStorage.removeItem(SESS_KEY); }

    const DEMO_SALT = 'samriddhi'; // demo-only
    const hash = (s)=> btoa(unescape(encodeURIComponent(DEMO_SALT + '|' + s)));

    // ====== Home
    $('#btnStart').onclick = ()=> show('login');
    $('#btnOpenLogin').onclick = ()=> show('login');

    // ====== Login step 1
    $('#btnProceedPhone').onclick = ()=>{
      const ph = ($('#phoneNumber').value || '').replace(/\D/g,'');
      if(ph.length !== 10){ $('#login_msg').textContent = 'Enter a valid 10-digit number.'; return; }
      localStorage.setItem('sam_tmp_phone', ph);
      const accounts = getAccounts();
      if(accounts[ph]){
        show('password');
      }else{
        $('#create_phone').value = ph;
        show('create');
      }
    };

    // ====== Existing user: password
    $('#btnLogin').onclick = ()=>{
      const ph = localStorage.getItem('sam_tmp_phone') || '';
      const pw = $('#login_pass').value;
      const accs = getAccounts();
      if(!accs[ph]){ $('#pass_msg').textContent='Account not found.'; return; }
      if(accs[ph].pw !== hash(pw)){ $('#pass_msg').textContent='Wrong password.'; return; }
      const sess = { phone: ph, name: accs[ph].name || '', city: accs[ph].city || '', lang: accs[ph].lang || 'English', job: accs[ph].job || '' };
      setSession(sess);
      $('#btnOpenLogin').classList.add('hidden'); $('#navProfile').classList.remove('hidden');
      show('dashboard');
      refreshDashboard();
    };

    // ====== New user: create
    $('#btnCreate').onclick = ()=>{
      const ph = localStorage.getItem('sam_tmp_phone') || '';
      const name = $('#create_name').value.trim();
      const city = $('#create_city').value.trim();
      const lang = $('#create_lang').value;
      const job = $('#create_job').value.trim();
      const pw = $('#create_pw').value;
      const cpw = $('#create_cpw').value;
      if(pw.length < 4){ $('#create_msg').textContent='Password too short.'; return; }
      if(pw !== cpw){ $('#create_msg').textContent='Passwords do not match.'; return; }
      const accs = getAccounts();
      accs[ph] = { name, city, lang, job, pw: hash(pw) };
      setAccounts(accs);
      const sess = { phone: ph, name, city, lang, job };
      setSession(sess);
      $('#btnOpenLogin').classList.add('hidden'); $('#navProfile').classList.remove('hidden');
      show('dashboard');
      refreshDashboard(true); // first-time
    };

    // ====== Dashboard state
    function refreshDashboard(isNew=false){
      const score = Number(localStorage.getItem(LIT_SCORE) || 0);
      const level = localStorage.getItem(LIT_LEVEL) || '‚Äî';
      const prog = Math.round((Number(localStorage.getItem(COURSE_PROGRESS) || 0))*100);
      $('#progBar').style.width = prog + '%';
      $('#progPct').textContent = prog + '%';
      $('#litLevel').textContent = level;
      $('#litScore').textContent = isNaN(score) ? '0' : String(score);

      const mustTest = isNew || !localStorage.getItem(LIT_LEVEL);
      $('#btnResume').classList.toggle('locked', mustTest);
      $('#btnExplorePrograms').classList.toggle('locked', mustTest);
      $('#lockMsg').textContent = mustTest ? 'Complete the Financial Literacy Test to unlock Programs.' : '';

      $('#btnTakeTest').onclick = ()=> show('lit');
      $('#btnResume').onclick = ()=> resumeCourse();
    }

    // ====== Literacy test
    const litQs = [
      ['If you deposit ‚Çπ100 at 8% yearly, about how much after 1 year?', ['‚Çπ108','‚Çπ118','‚Çπ180'], 0],
      ['Which is safer place to keep savings?', ['Under mattress','Bank savings account','Friend'], 1],
      ['EMI should be at most what % of monthly income (rule of thumb)?', ['35%','60%','90%'], 0],
      ['What does FD stand for?', ['Fixed Deposit','Fast Deposit','Fund Deposit'], 0],
      ['RD means‚Ä¶', ['Recurring Deposit','Rate Deposit','Ready Deposit'], 0],
      ['Higher interest always better, regardless of risk?', ['True','False'], 1],
      ['Late EMI payment affects credit score?', ['Yes','No'], 0],
      ['Compound interest means‚Ä¶', ['Interest on interest','Interest only on principal','Daily bank charges'], 0],
      ['To grow a shop, which is working capital?', ['Daily cash for orders','Buying land','Gold jewellery'], 0],
      ['Best way to track expenses?', ['Memory','Cashbook','Borrowing'], 1],
    ];
    function renderLit(){
      const host = $('#litForm'); host.innerHTML='';
      litQs.forEach((q,qi)=>{
        const box = document.createElement('div'); box.className='card'; box.style.margin='8px 0';
        box.innerHTML = `<strong>${qi+1}. ${q[0]}</strong>` + q[1].map((o,oi)=>`
          <label style="display:flex;gap:8px;align-items:center;margin:6px 0">
            <input type="radio" name="lit_${qi}" value="${oi}"/> <span>${o}</span>
          </label>
        `).join('');
        host.appendChild(box);
      });
    }
    $('#litSubmit').onclick = ()=>{
      let score=0;
      litQs.forEach((q,qi)=>{
        const sel = document.querySelector(`input[name='lit_${qi}']:checked`);
        if(sel && Number(sel.value)===q[2]) score++;
      });
      let level='Beginner'; if(score>=8) level='Advanced'; else if(score>=5) level='Intermediate';
      localStorage.setItem(LIT_SCORE, String(score));
      localStorage.setItem(LIT_LEVEL, level);
      $('#litMsg').innerHTML = `<span class="ok">Score ${score}/10 ‚Ä¢ Level: ${level}</span>`;
      setTimeout(()=>{ show('dashboard'); refreshDashboard(); }, 800);
    };
    $('#litReset').onclick = ()=>{ localStorage.removeItem(LIT_SCORE); localStorage.removeItem(LIT_LEVEL); $('#litMsg').textContent=''; $$("input[name^='lit_']").forEach(i=>i.checked=false); };

    // ====== Programs (modules demo)
    const YT_EMBED = 'https://www.youtube-nocookie.com/embed/dQw4w9WgXcQ?rel=0&modestbranding=1&playsinline=1';
    const modules = [
      {title: 'Introduction to Tailoring', minutes: 65, items: [
        { type:'video', title:'Welcome & safety', mins:6 },
        { type:'video', title:'Understanding your machine', mins:12 },
        { type:'quiz',  title:'Checkpoint Quiz 1', mins:5, quizId:'q1' },
        { type:'video', title:'Threads & needles', mins:10 },
        { type:'reading', title:'Finding fabric locally', mins:6 },
        { type:'video', title:'Your first stitch', mins:10 },
        { type:'video', title:'Care & maintenance', mins:16 }
      ]},
      {title: 'Business Basics', minutes: 35, items: [
        { type:'video', title:'Pricing a blouse', mins:12 },
        { type:'quiz',  title:'Checkpoint Quiz 2', mins:5, quizId:'q2' },
        { type:'video', title:'Managing orders', mins:8 },
        { type:'reading', title:'Keeping a cashbook', mins:10 }
      ]}
    ];
    const quizBanks = {
      q1: [
        { q:'Best way to record daily cash?', opts:['Memory','Cashbook','Bank passbook'], ans:1 },
        { q:'What goes into blouse price?', opts:['Thread only','Fabric only','All materials & time'], ans:2 },
        { q:'Service the machine?', opts:['Never','When broken','Regularly as per manual'], ans:2 }
      ],
      q2: [
        { q:'Why keep a cashbook?', opts:['Decoration','Track income & expense','Only to show bank'], ans:1 },
        { q:'Working capital example?', opts:['Daily cash for orders','Buying a shop','Buying land'], ans:0 },
        { q:'If income ‚Çπ15k, safe EMI share ~', opts:['10%','35%','80%'], ans:1 }
      ]
    };

    function closeAllDetails(){
      $$('.item-details.open').forEach(d=>{
        d.classList.remove('open');
        const ifr = d.querySelector('iframe');
        if(ifr){ ifr.src='about:blank'; ifr.remove(); }
      });
    }
    function renderModules(){
      const host = $('#moduleList'); if(!host) return; host.innerHTML='';
      let total=0; let doneCount=0; 
      const state = JSON.parse(localStorage.getItem(COURSE_STATE) || '{"moduleIndex":0,"itemIndex":0}');
      modules.forEach((mod, mi)=>{
        total += mod.minutes;
        const sec = document.createElement('section');
        sec.className = 'module-sec';
        sec.innerHTML = `
          <div class="sec-head">
            <div>
              <button class="collapse-btn" data-i="${mi}" aria-expanded="true" aria-controls="items-${mi}">‚ñæ</button>
              <span class="sec-title">${mi+1}. ${mod.title}</span>
            </div>
            <span class="muted">${mod.minutes}m</span>
          </div>
          <div class="items" id="items-${mi}"></div>
        `;
        host.appendChild(sec);
        const items = sec.querySelector('.items');
        mod.items.forEach((it, ii)=>{
          const row = document.createElement('div');
          row.className = 'item-row';
          row.dataset.type = it.type;
          row.dataset.mi = mi; row.dataset.ii = ii;
          if(it.quizId) row.dataset.quizid = it.quizId;
          row.innerHTML = `
            <div class="left">
              <button class="play-btn ghost-icon" title="Open">${it.type==='video'?'‚ñ∂':(it.type==='quiz'?'üìù':'üìÑ')}</button>
              <div class="it-title">${it.title}</div>
            </div>
            <div class="right">
              <span class="muted">${it.mins}m</span>
            </div>
          `;
          const details = document.createElement('div');
          details.className = 'item-details';
          details.innerHTML = `<div class="holder"></div>`;
          items.appendChild(row); items.appendChild(details);

          row.addEventListener('click', (e)=>{
            if(e.target.closest('.ghost-icon') && !e.target.classList.contains('play-btn')) return;
            toggleItem(row);
          });

          // progress calc: items before current state are considered done
          if(mi < state.moduleIndex || (mi===state.moduleIndex && ii < state.itemIndex)) doneCount++;
        });
      });
      $('#totalLen').textContent = total + 'm';
      $$('.collapse-btn').forEach(btn=>{
        btn.onclick = (e)=>{
          const i = e.currentTarget.getAttribute('data-i');
          const box = document.querySelector('#items-'+i);
          const isHidden = box.classList.toggle('hidden');
          e.currentTarget.textContent = isHidden ? '‚ñ∏' : '‚ñæ';
          e.currentTarget.setAttribute('aria-expanded', String(!isHidden));
          if(isHidden) closeAllDetails();
        };
      });
      const totalItems = modules.reduce((a,m)=>a+m.items.length,0);
      const pct = Math.min(1, doneCount/totalItems);
      localStorage.setItem(COURSE_PROGRESS, String(pct));
    }
    function toggleItem(row){
      const details = row.nextElementSibling;
      const open = details.classList.contains('open');
      if(open){
        details.classList.remove('open');
        const ifr = details.querySelector('iframe');
        if(ifr){ ifr.src='about:blank'; ifr.remove(); }
        return;
      }
      closeAllDetails();
      details.classList.add('open');
      const holder = details.querySelector('.holder'); holder.innerHTML='';
      const kind = row.dataset.type;
      const mi = Number(row.dataset.mi), ii = Number(row.dataset.ii);
      localStorage.setItem(COURSE_STATE, JSON.stringify({moduleIndex:mi,itemIndex:ii}));

      if(kind==='video'){
        const iframe = document.createElement('iframe');
        iframe.className = 'yt';
        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
        iframe.allowFullscreen = true;
        iframe.src = YT_EMBED;
        holder.appendChild(iframe);
      } else if(kind==='quiz'){
        const id = row.dataset.quizid;
        const qs = quizBanks[id] || [];
        const form = document.createElement('div');
        form.innerHTML = qs.map((it, i)=>`
          <div class='card' style='margin:8px 0'>
            <div style='font-weight:700;margin-bottom:6px'>${i+1}. ${it.q}</div>
            ${it.opts.map((o,j)=>`<label style="display:flex;gap:8px;align-items:center;margin:4px 0"><input type="radio" name="${id}_q${i}" value="${j}"/> <span>${o}</span></label>`).join('')}
          </div>
        `).join('');
        const submit=document.createElement('button'); submit.className='btn primary'; submit.textContent='Submit quiz';
        const result=document.createElement('span'); result.className='muted'; result.style.marginLeft='8px';
        holder.appendChild(form); holder.appendChild(submit); holder.appendChild(result);
        submit.onclick=()=>{
          let score=0; qs.forEach((qq,i)=>{ const sel = holder.querySelector(`input[name='${id}_q${i}']:checked`); if(sel && Number(sel.value)===qq.ans) score++; });
          result.innerHTML = (score===qs.length) ? `<span class='ok'>Perfect! ${score}/${qs.length}</span>` : `<span class='err'>Score: ${score}/${qs.length}</span>`;
          localStorage.setItem('sam_quiz_'+id, String(score));
        };
      } else {
        holder.innerHTML = '<div class="muted">Reading: short tips and checklists (placeholder).</div>';
      }
      details.scrollIntoView({behavior:'smooth', block:'center'});
    }
    function resumeCourse(){
      const state = JSON.parse(localStorage.getItem(COURSE_STATE) || 'null');
      show('modules'); renderModules();
      if(!state) return;
      const row = document.querySelector(`[data-mi='${state.moduleIndex}'][data-ii='${state.itemIndex}']`);
      if(row) toggleItem(row);
    }

    // ====== Banking formulas
    function calcFD(principal, ratePct, months){
      const qRate = ratePct/100/4;
      const years = months/12;
      return Math.round(principal * Math.pow(1 + qRate, 4*years));
    }
    function calcRD(monthly, ratePct, months){
      const r = ratePct/100/12;
      return Math.round(monthly * (((Math.pow(1+r, months)-1)/r) * (1+r)));
    }
    function calcEMI(P, ratePct, n){
      const r = ratePct/100/12;
      return P * r * Math.pow(1+r, n) / (Math.pow(1+r, n)-1);
    }

    // ====== Banking wiring
    function updateFD(){
      const parts = $('#tenurePick').value.split('|').map(Number);
      const months = parts[0]; const rate = parts[1];
      const amt = Number($('#invAmount').value||0);
      $('#fInv').textContent = '‚Çπ' + amt.toLocaleString('en-IN');
      $('#fRate').textContent = rate + '%';
      $('#fTenure').textContent = (months/12) + 'Y';
      const mat = calcFD(amt, rate, months);
      $('#fMaturity').textContent = '‚Çπ' + mat.toLocaleString('en-IN');
    }
    function updateRD(){
      const A = Number($('#rd_amt').value||0);
      const M = Number($('#rd_months').value||0);
      const r = 7.5; // demo rate
      const out = calcRD(A, r, M);
      $('#rd_out').textContent = '‚Çπ' + out.toLocaleString('en-IN');
    }
    function updateEMI(){
      const P = Number($('#loan_amt').value||0);
      const n = Number($('#loan_tenure').value||0);
      const rate = Number($('#loan_rate').value||0);
      const I = Number($('#loan_income').value||0);
      const E = Number($('#loan_emi').value||0);
      if(P>0 && n>0 && rate>0){
        const emi = calcEMI(P, rate, n);
        $('#emi_out').textContent = '‚Çπ' + Math.round(emi).toLocaleString('en-IN');
        const ok = (emi + E) <= 0.35 * I;
        $('#emi_out').style.color = ok ? '#166534' : '#b91c1c';
      }
    }

    // ====== Profile & logout
    function loadProfileUI(){
      const sess = getSession() || {};
      $('#prof_phone').value = sess.phone || '';
      $('#prof_name').value = sess.name || '';
      $('#prof_city').value = sess.city || '';
      $('#prof_job').value = sess.job || '';
      $('#prof_lang').value = sess.lang || 'English';
      const sc = localStorage.getItem(LIT_SCORE)||'0';
      const lv = localStorage.getItem(LIT_LEVEL)||'‚Äî';
      $('#prof_lit').textContent = lv + ' ('+sc+'/10)';
      const pct = Math.round((Number(localStorage.getItem(COURSE_PROGRESS)||0))*100);
      $('#prof_prog').textContent = pct + '%';
    }
    $('#prof_save').onclick = ()=>{
      const sess = getSession() || {};
      const accs = getAccounts();
      const ph = sess.phone;
      const updated = {
        ...accs[ph],
        name: $('#prof_name').value.trim(),
        city: $('#prof_city').value.trim(),
        job: $('#prof_job').value.trim(),
        lang: $('#prof_lang').value,
        pw: $('#prof_pw').value ? hash($('#prof_pw').value) : accs[ph]?.pw
      };
      accs[ph] = updated; setAccounts(accs);
      setSession({ ...sess, ...updated, pw: undefined });
      $('#prof_pw').value='';
      $('#prof_msg').innerHTML = '<span class="ok">Saved.</span>';
    };
    $('#prof_logout').onclick = ()=>{
      clearSession();
      $('#navProfile').classList.add('hidden');
      $('#btnOpenLogin').classList.remove('hidden');
      show('home');
    };

    // ====== Toolkits: generate dummy files
    function makeBlob(name){
      let mime = 'text/plain';
      if(name.endsWith('.xlsx')) mime = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
      if(name.endsWith('.csv')) mime = 'text/csv';
      const data = 'Samriddhi Toolkit - ' + name + '\nSample data';
      const url = URL.createObjectURL(new Blob([data], {type:mime}));
      return url;
    }
    function wireToolkits(){
      $$('#page-toolkits [data-dl]').forEach(btn=>{
        btn.onclick = ()=>{
          const name = btn.getAttribute('data-dl');
          const a = document.createElement('a'); a.href = makeBlob(name); a.download = name; a.click();
        };
      });
    }

    // ====== Init
    function init(){
      renderLit();
      renderModules();
      updateFD(); updateRD(); updateEMI();
      $('#tenurePick').onchange = updateFD; $('#invAmount').oninput = updateFD;
      $('#rd_amt').oninput = updateRD; $('#rd_months').oninput = updateRD;
      ['loan_amt','loan_tenure','loan_rate','loan_income','loan_emi'].forEach(id=> $('#'+id).oninput = updateEMI);

      const sess = getSession();
      if(sess){ $('#navProfile').classList.remove('hidden'); $('#btnOpenLogin').classList.add('hidden'); }
      const raw = location.hash.replace('#/','') || 'home';
      show(PAGES.includes(raw) ? raw : 'home');
      refreshDashboard();
      wireToolkits();
    }
    init();

    // Observe route changes to load profile UI lazily
    const ro = new MutationObserver(()=>{ if(!$('#page-profile').classList.contains('hidden')) loadProfileUI(); if(!$('#page-dashboard').classList.contains('hidden')) refreshDashboard(); });
    ro.observe(document.body, {subtree:true, attributes:true, attributeFilter:['class']});
  </script>
</body>
</html>
